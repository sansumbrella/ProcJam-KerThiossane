<html>
<head>
    <meta charset="utf-8"></meta>
    <title>KÃ«r Thiossane Sample Code: Branching Graph</title>
</head>
<body>
    <h1>Hello</h1>
    <canvas id="canvas" width=640 height=480>
        Fallback content.
    </canvas>
</body>
<script type="text/javascript">
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");

    function createBranchShape(length, width) {
        var radius = width / 2;
        var p = new Path2D();
        p.arc(0, 0, radius, 0, 2 * Math.PI);
        p.arc(length, 0, radius, 0, 2 * Math.PI);
        p.rect(0, -radius, length, width);
        return p;
    }

    function random(low, high) {
        var range = high - low;
        return low + Math.random() * range;
    }

    function mix(a, b, t) {
        return a + (b - a) * t;
    }

    function drawTree(tree) {
        var branchShape = createBranchShape(1.0, 0.1);

        function draw(branch) {
            ctx.save();   
            ctx.translate(branch.x, branch.y);
            ctx.rotate(branch.angle);
            ctx.save();
            ctx.scale(branch.size, branch.size);
            ctx.fill(branchShape);
            ctx.restore();

            for (var child of branch.branches) {
                draw(child);
            }

            ctx.restore();
        }
        
        draw(tree);
    }

    function makeTree(size) {
        var tree = {
            x: canvas.width / 2,
            y: canvas.height,
            size: size,
            angle: -Math.PI * 0.5,
            branches: []
        };

        tree.low = tree.angle;
        tree.high = tree.angle;

        function grow(parent) {
            if (parent.size > size * 0.5) {
                var numBranches = Math.floor(random(2, 5));
                for (var i = 0; i < numBranches; i += 1) {
                    var child = {
                        size: parent.size * random(0.8, 0.92),
                        x: parent.size,
                        y: 0,
                        angle: random(-Math.PI * 0.2, Math.PI * 0.2),
                        branches: []
                    };
                    child.low = child.angle - random(0.1, 0.2);
                    child.high = child.angle + random(0.1, 0.2);
                    parent.branches.push(child);
                }
            }
            for (var branch of parent.branches) {
                grow(branch);
            }
        }

        grow(tree);
        return tree;
    }

    function sway(tree) {
        var time = new Date().getTime() * 0.001;
        var cosine = (Math.cos(time) + 1.0) / 2.0;
        function recur(branch, weight) {
            branch.angle = mix(branch.low, branch.high, cosine * weight);
            for (var child of branch.branches) {
                recur(child, weight + 0.02);
            }
        }

        recur(tree, 0.0);
    }

    var tree = makeTree(60.0);
    drawTree(tree);

    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawTree(tree);
        sway(tree);
        
        if (running) {
            window.requestAnimationFrame(update);
        }
    }

    var running = true;
    update();
</script>
</html>
